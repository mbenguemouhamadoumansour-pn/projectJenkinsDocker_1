pipeline {
    agent any
    
    environment {
        // Configuration DockerHub
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'mouhamadoumbengue'
        
        // Noms des images
        BACKEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-backend"
        FRONTEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-frontend"
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // Configuration Kubernetes
        K8S_NAMESPACE = 'smartphone-app'
        K8S_CONTEXT = 'minikube'
        
        // Configuration SonarQube
        SONAR_PROJECT_KEY = 'Smartphone-Management-App'
        
        // Configuration Email
        RECIPIENT_EMAIL = 'mbenguemouhamadoumansour@gmail.com'
    }
    
    stages {
        stage('ğŸ§¹ Cleanup Workspace') {
            steps {
                echo 'Nettoyage du workspace...'
                cleanWs()
            }
        }
        
        stage('ğŸ”„ Checkout from GitHub') {
            steps {
                echo 'RÃ©cupÃ©ration du code depuis GitHub...'
                git branch: 'main',
                    credentialsId: 'github-credentials',
                    url: 'https://github.com/mbenguemouhamadoumansour-pn/projectJenkinsDocker_1.git'
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            parallel {
                stage('Backend Dependencies') {
                    steps {
                        dir('backend') {
                            echo 'Installation des dÃ©pendances backend...'
                            sh 'npm install'
                        }
                    }
                }
                stage('Frontend Dependencies') {
                    steps {
                        dir('frontend') {
                            echo 'Installation des dÃ©pendances frontend...'
                            sh 'npm install'
                        }
                    }
                }
            }
        }
        
        stage('ğŸ§ª Run Tests') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('backend') {
                            echo 'ExÃ©cution des tests backend...'
                            sh 'npm test -- --coverage --watchAll=false || true'
                        }
                    }
                }
                stage('Frontend Tests') {
                    steps {
                        dir('frontend') {
                            echo 'ExÃ©cution des tests frontend...'
                            sh 'CI=true npm test -- --coverage --watchAll=false || true'
                        }
                    }
                }
            }
        }
        
        stage('ğŸ” SonarQube Analysis') {
            steps {
                echo 'Analyse de la qualitÃ© du code avec SonarQube...'
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv('SonarQube') {
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                              -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                              -Dsonar.sources=. \
                              -Dsonar.host.url=http://localhost:9000
                        """
                    }
                }
            }
        }
        
        stage('ğŸš¦ Quality Gate') {
            steps {
                echo 'VÃ©rification du Quality Gate SonarQube...'
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline interrompu : Quality Gate Ã©chouÃ© avec le statut ${qg.status}"
                        }
                        echo 'âœ… Quality Gate passÃ© avec succÃ¨s !'
                    }
                }
            }
        }
        
        stage('ğŸ³ Build Docker Images') {
            parallel {
                stage('Build Backend Image') {
                    steps {
                        dir('backend') {
                            echo 'Construction de l\'image Docker backend...'
                            sh """
                                docker build -t ${BACKEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${BACKEND_IMAGE}:${IMAGE_TAG} ${BACKEND_IMAGE}:latest
                            """
                        }
                    }
                }
                stage('Build Frontend Image') {
                    steps {
                        dir('frontend') {
                            echo 'Construction de l\'image Docker frontend...'
                            sh """
                                docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${FRONTEND_IMAGE}:${IMAGE_TAG} ${FRONTEND_IMAGE}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to DockerHub') {
            steps {
                echo 'Push des images vers DockerHub...'
                script {
                    sh """
                        echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                        
                        # Push Backend
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${BACKEND_IMAGE}:latest
                        
                        # Push Frontend
                        docker push ${FRONTEND_IMAGE}:${IMAGE_TAG}
                        docker push ${FRONTEND_IMAGE}:latest
                        
                        docker logout
                    """
                }
                echo 'âœ… Images poussÃ©es avec succÃ¨s sur DockerHub'
            }
        }
        
        stage('ğŸš€ Deploy to Kubernetes') {
            steps {
                echo 'DÃ©ploiement sur Kubernetes (Minikube)...'
                script {
                    sh """
                        # VÃ©rifier la connexion Ã  Kubernetes
                        kubectl cluster-info
                        
                        # CrÃ©er le namespace s'il n'existe pas
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        
                        # Appliquer les manifests Kubernetes
                        kubectl apply -k k8s/
                        
                        # Attendre que les deployments soient prÃªts
                        kubectl rollout status deployment/mongodb -n ${K8S_NAMESPACE} --timeout=5m
                        kubectl rollout status deployment/smartphone-backend -n ${K8S_NAMESPACE} --timeout=5m
                        kubectl rollout status deployment/smartphone-frontend -n ${K8S_NAMESPACE} --timeout=5m
                    """
                }
                echo 'âœ… DÃ©ploiement sur Kubernetes rÃ©ussi !'
            }
        }
        
        stage('ğŸ’š Health Checks') {
            steps {
                echo 'VÃ©rification de santÃ© des services Kubernetes...'
                script {
                    sh '''
                        echo "Attente de la disponibilitÃ© des pods..."
                        sleep 10
                        
                        echo "VÃ©rification des pods..."
                        kubectl get pods -n smartphone-app
                        
                        echo "VÃ©rification des services..."
                        kubectl get svc -n smartphone-app
                        
                        echo "VÃ©rification des logs backend..."
                        kubectl logs -n smartphone-app -l app=smartphone-backend --tail=50
                    '''
                }
                echo 'âœ… SantÃ© des services vÃ©rifiÃ©e !'
            }
        }
        
        stage('ğŸ“Š Display Deployment Info') {
            steps {
                script {
                    sh '''
                        echo ""
                        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                        echo "â•‘           ğŸ‰ DÃ‰PLOIEMENT KUBERNETES RÃ‰USSI ! ğŸ‰             â•‘"
                        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                        echo "â•‘  ğŸ“± Application Smartphone Management                      â•‘"
                        echo "â•‘                                                            â•‘"
                        echo "â•‘  ğŸŒ Frontend: http://localhost:30080                       â•‘"
                        echo "â•‘  ğŸ”§ Backend:  http://localhost:5000                        â•‘"
                        echo "â•‘  ğŸ—„ï¸  MongoDB: mongodb://localhost:27017                    â•‘"
                        echo "â•‘  ğŸ“Š SonarQube: http://localhost:9000                       â•‘"
                        echo "â•‘                                                            â•‘"
                        echo "â•‘  ğŸ·ï¸  Build:     #${BUILD_NUMBER}                           â•‘"
                        echo "â•‘  ğŸ“¦ Namespace: ${K8S_NAMESPACE}                            â•‘"
                        echo "â•‘  â˜¸ï¸  Context:   ${K8S_CONTEXT}                             â•‘"
                        echo "â•‘                                                            â•‘"
                        echo "â•‘  ğŸ“‹ Pods Kubernetes:                                       â•‘"
                        kubectl get pods -n smartphone-app | tail -n +2 | awk '{printf "â•‘  â€¢ %s\\n", $0}'
                        echo "â•‘                                                            â•‘"
                        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo ""
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'Nettoyage des images Docker inutilisÃ©es...'
            sh '''
                docker image prune -f || true
                docker system prune -f --volumes || true
            '''
        }
        
        success {
            echo 'âœ… Pipeline exÃ©cutÃ© avec succÃ¨s !'
            emailext(
                subject: "âœ… SUCCESS: Smartphone App Build #${BUILD_NUMBER} - Kubernetes",
                body: """
<html>
<body style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
    <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px;">
        <h1 style="color: #28a745; border-bottom: 3px solid #28a745; padding-bottom: 10px;">
            âœ… DÃ©ploiement Kubernetes rÃ©ussi !
        </h1>
        
        <div style="background-color: #e8f5e9; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #2e7d32;">ğŸ“± AccÃ¨s Ã  l'application :</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li style="margin: 10px 0;">
                    <strong>Frontend:</strong> <a href="http://localhost:30080" style="color: #1976d2;">http://localhost:30080</a>
                </li>
                <li style="margin: 10px 0;">
                    <strong>Backend:</strong> <a href="http://localhost:5000" style="color: #1976d2;">http://localhost:5000</a>
                </li>
                <li style="margin: 10px 0;">
                    <strong>SonarQube:</strong> <a href="http://localhost:9000" style="color: #1976d2;">http://localhost:9000</a>
                </li>
            </ul>
        </div>
        
        <div style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #333;">ğŸ“¦ Informations Kubernetes :</h3>
            <ul style="list-style: none; padding-left: 0;">
                <li><strong>Build:</strong> #${BUILD_NUMBER}</li>
                <li><strong>Namespace:</strong> smartphone-app</li>
                <li><strong>Context:</strong> minikube</li>
                <li><strong>Status:</strong> Tous les services sont dÃ©ployÃ©s et sains</li>
            </ul>
        </div>
        
        <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;">
            Ce message a Ã©tÃ© gÃ©nÃ©rÃ© automatiquement par Jenkins
        </p>
    </div>
</body>
</html>
                """,
                to: "${RECIPIENT_EMAIL}",
                mimeType: 'text/html'
            )
        }
        
        failure {
            echo 'âŒ Le pipeline a Ã©chouÃ© !'
            emailext(
                subject: "âŒ FAILED: Smartphone App Build #${BUILD_NUMBER}",
                body: """
<html>
<body style="font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4;">
    <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px;">
        <h1 style="color: #dc3545; border-bottom: 3px solid #dc3545; padding-bottom: 10px;">
            âŒ Ã‰chec du dÃ©ploiement
        </h1>
        
        <p>Le build #${BUILD_NUMBER} a Ã©chouÃ©. Veuillez vÃ©rifier les logs pour plus de dÃ©tails.</p>
        
        <div style="margin-top: 30px; text-align: center;">
            <a href="${BUILD_URL}console" 
               style="background-color: #dc3545; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
                ğŸ“‹ Voir les logs
            </a>
        </div>
    </div>
</body>
</html>
                """,
                to: "${RECIPIENT_EMAIL}",
                mimeType: 'text/html'
            )
        }
    }
}