pipeline {
    agent any
    
    environment {
        DOCKERHUB_CREDENTIALS = credentials('dockerhub')
        DOCKERHUB_USERNAME = 'mouhamadoumbengue'
        
        BACKEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-backend"
        FRONTEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-frontend"
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        K8S_NAMESPACE = 'smartphone-app'
        SONAR_PROJECT_KEY = 'Smartphone-Management-App'
        
        BACKEND_PORT = '30500'
        FRONTEND_PORT = '30080'
    }
    
    stages {
        stage('üßπ Cleanup') {
            steps {
                echo 'Nettoyage du workspace...'
                cleanWs()
            }
        }
        
        stage('üîÑ Checkout') {
            steps {
                echo 'R√©cup√©ration du code depuis GitHub (shallow clone)...'
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    extensions: [
                        [$class: 'CloneOption', 
                         shallow: true, 
                         depth: 1,
                         timeout: 30
                        ]
                    ],
                    userRemoteConfigs: [[
                        url: 'https://github.com/mbenguemouhamadoumansour-pn/projectJenkinsDocker_1.git'
                    ]]
                ])
            }
        }
        
        stage('üîç SonarQube Analysis') {
            steps {
                echo 'Analyse du code avec SonarQube...'
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    script {
                        def scannerHome = tool 'SonarScanner'
                        withSonarQubeEnv('SonarQube') {
                            sh """
                                ${scannerHome}/bin/sonar-scanner \
                                -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                                -Dsonar.sources=. \
                                -Dsonar.host.url=http://sonarqube:9000
                            """
                        }
                    }
                }
                echo "‚úÖ Analyse SonarQube termin√©e (ou ignor√©e si erreur)"
            }
        }

        
        stage('üê≥ Build Docker Images') {
            parallel {
                stage('Build Backend') {
                    steps {
                        dir('backend') {
                            sh """
                                docker build -t ${BACKEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${BACKEND_IMAGE}:${IMAGE_TAG} ${BACKEND_IMAGE}:latest
                            """
                        }
                    }
                }
                stage('Build Frontend') {
                    steps {
                        dir('frontend') {
                            sh """
                                docker build -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${FRONTEND_IMAGE}:${IMAGE_TAG} ${FRONTEND_IMAGE}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('üì§ Push to DockerHub') {
            steps {
                script {
                    sh """
                        echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                        
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${BACKEND_IMAGE}:latest
                        
                        docker push ${FRONTEND_IMAGE}:${IMAGE_TAG}
                        docker push ${FRONTEND_IMAGE}:latest
                        
                        docker logout
                    """
                }
            }
        }
        
        stage('üöÄ Deploy to Kubernetes') {
            steps {
                script {
                    sh """
                        # Cr√©er le namespace
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        
                        # Cr√©er/Mettre √† jour le ConfigMap
                        kubectl delete configmap backend-config -n ${K8S_NAMESPACE} --ignore-not-found
                        kubectl create configmap backend-config \
                          --from-literal=MONGODB_URI=mongodb://smartphone-mongo:27017/samadb \
                          --from-literal=PORT=5000 \
                          --from-literal=NODE_ENV=production \
                          -n ${K8S_NAMESPACE}
                        
                        # Cr√©er/Mettre √† jour le Secret DockerHub
                        kubectl delete secret dockerhub-secret -n ${K8S_NAMESPACE} --ignore-not-found
                        kubectl create secret docker-registry dockerhub-secret \
                          --docker-server=docker.io \
                          --docker-username=${DOCKERHUB_USERNAME} \
                          --docker-password=\${DOCKERHUB_CREDENTIALS_PSW} \
                          --docker-email=jenkins@example.com \
                          -n ${K8S_NAMESPACE}
                        
                        # D√©ployer les ressources Kubernetes
                        kubectl apply -f k8s/namespace.yaml
                        kubectl apply -f k8s/mongodb-pvc.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/mongodb-service.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/mongodb-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/backend-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/backend-service.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/frontend-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/frontend-service.yaml -n ${K8S_NAMESPACE}
                        
                        # Attendre que les d√©ploiements soient pr√™ts
                        echo "‚è≥ Attente du d√©ploiement..."
                        kubectl rollout status deployment/smartphone-mongo -n ${K8S_NAMESPACE} --timeout=3m || true
                        kubectl rollout status deployment/smartphone-backend -n ${K8S_NAMESPACE} --timeout=3m || true
                        kubectl rollout status deployment/smartphone-frontend -n ${K8S_NAMESPACE} --timeout=3m || true
                    """
                }
            }
        }
        
        stage('‚úÖ Verification') {
            steps {
                script {
                    sh """
                        echo "======================================"
                        echo "üìä √âTAT DES D√âPLOIEMENTS"
                        echo "======================================"
                        
                        kubectl get pods -n ${K8S_NAMESPACE} -o wide
                        kubectl get svc -n ${K8S_NAMESPACE}
                        
                        echo ""
                        echo "‚úÖ D√âPLOIEMENT R√âUSSI!"
                        echo "üì± Frontend: http://\$(hostname -I | awk '{print \$1}'):${FRONTEND_PORT}"
                        echo "üîß Backend:  http://\$(hostname -I | awk '{print \$1}'):${BACKEND_PORT}"
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                try {
                    sh 'docker image prune -f || true'
                    sh 'df -h'
                } catch (Exception e) {
                    echo "Impossible d'afficher l'espace disque Docker"
                }
            }
        }
        success {
            echo '‚úÖ ========================================='
            echo '‚úÖ PIPELINE TERMIN√â AVEC SUCC√àS!'
            echo '‚úÖ ========================================='
            echo "‚úÖ Build #${BUILD_NUMBER} d√©ploy√©"
        }
        failure {
            echo '‚ùå ========================================='
            echo '‚ùå PIPELINE √âCHOU√â'
            echo '‚ùå ========================================='
            echo "‚ùå Build #${BUILD_NUMBER} a √©chou√©"
            echo "‚ùå Consultez les logs pour plus de d√©tails"
        }
    }
}
