pipeline {
    agent any
    
    environment {
        // Configuration DockerHub - Ã€ MODIFIER
        DOCKERHUB_CREDENTIALS = credentials('dockerhub-credentials')
        DOCKERHUB_USERNAME = 'mouhamadoumbengue'  // Ã€ MODIFIER
        
        // Noms des images
        BACKEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-backend"
        FRONTEND_IMAGE = "${DOCKERHUB_USERNAME}/smartphone-frontend"
        IMAGE_TAG = "${BUILD_NUMBER}"
        
        // Configuration Kubernetes
        K8S_NAMESPACE = 'smartphone-app'
        K8S_CONTEXT = 'minikube'
        
        // Configuration Ports - AJOUT IMPORTANT
        BACKEND_PORT = '5000'
        FRONTEND_PORT = '80'
        MONGO_PORT = '27017'
        
        // Configuration SonarQube
        SONAR_PROJECT_KEY = 'Smartphone-Management-App'
        
        // Configuration Email
        RECIPIENT_EMAIL = 'mbenguemouhamadoumansour@gmail.com'  // Ã€ MODIFIER
    }
    
    stages {
        stage('ğŸ§¹ Cleanup Workspace') {
            steps {
                echo 'Nettoyage du workspace...'
                cleanWs()
            }
        }
        
        stage('ğŸ”„ Checkout from GitHub') {
            steps {
                echo 'RÃ©cupÃ©ration du code depuis GitHub...'
                git branch: 'main',
                    credentialsId: 'github-credentials',
                    url: 'https://github.com/mbenguemouhamadoumansour-pn/projectJenkinsDocker_1.git'  // Ã€ MODIFIER
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            parallel {
                stage('Backend Dependencies') {
                    steps {
                        dir('backend') {
                            echo 'Installation des dÃ©pendances backend...'
                            sh 'npm install'
                        }
                    }
                }
                stage('Frontend Dependencies') {
                    steps {
                        dir('frontend') {
                            echo 'Installation des dÃ©pendances frontend...'
                            sh 'npm install'
                        }
                    }
                }
            }
        }
        
        stage('ğŸ§ª Run Tests') {
            parallel {
                stage('Backend Tests') {
                    steps {
                        dir('backend') {
                            echo 'ExÃ©cution des tests backend avec coverage...'
                            sh '''
                                npm test -- --coverage --watchAll=false || true
                            '''
                        }
                    }
                }
                stage('Frontend Tests') {
                    steps {
                        dir('frontend') {
                            echo 'ExÃ©cution des tests frontend avec coverage...'
                            sh '''
                                CI=true npm test -- --coverage --watchAll=false || true
                            '''
                        }
                    }
                }
            }
        }
        
        stage('ğŸ” SonarQube Analysis') {
            steps {
                echo 'Analyse de la qualitÃ© du code avec SonarQube...'
                script {
                    def scannerHome = tool 'SonarScanner'
                    withSonarQubeEnv('SonarQube') {
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                              -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                              -Dsonar.sources=. \
                              -Dsonar.host.url=http://localhost:9000
                        """
                    }
                }
            }
        }
        
        stage('ğŸš¦ Quality Gate') {
            steps {
                echo 'VÃ©rification du Quality Gate SonarQube...'
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline interrompu : Quality Gate Ã©chouÃ© avec le statut ${qg.status}"
                        }
                        echo 'âœ… Quality Gate passÃ© avec succÃ¨s !'
                    }
                }
            }
        }
        
        stage('ğŸ³ Build Docker Images') {
            parallel {
                stage('Build Backend Image') {
                    steps {
                        dir('backend') {
                            echo 'Construction de l\'image Docker backend...'
                            sh """
                                docker build -t ${BACKEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${BACKEND_IMAGE}:${IMAGE_TAG} ${BACKEND_IMAGE}:latest
                            """
                        }
                    }
                }
                stage('Build Frontend Image') {
                    steps {
                        dir('frontend') {
                            echo 'Construction de l\'image Docker frontend...'
                            sh """
                                docker build \
                                  --build-arg REACT_APP_API_URL=http://localhost:${BACKEND_PORT}/api \
                                  -t ${FRONTEND_IMAGE}:${IMAGE_TAG} .
                                docker tag ${FRONTEND_IMAGE}:${IMAGE_TAG} ${FRONTEND_IMAGE}:latest
                            """
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“¤ Push to DockerHub') {
            steps {
                echo 'Push des images vers DockerHub...'
                script {
                    sh """
                        echo \$DOCKERHUB_CREDENTIALS_PSW | docker login -u \$DOCKERHUB_CREDENTIALS_USR --password-stdin
                        
                        # Push Backend
                        docker push ${BACKEND_IMAGE}:${IMAGE_TAG}
                        docker push ${BACKEND_IMAGE}:latest
                        
                        # Push Frontend
                        docker push ${FRONTEND_IMAGE}:${IMAGE_TAG}
                        docker push ${FRONTEND_IMAGE}:latest
                        
                        docker logout
                    """
                }
                echo 'âœ… Images poussÃ©es avec succÃ¨s sur DockerHub'
            }
        }
        
        stage('ğŸš€ Deploy to Kubernetes') {
            steps {
                echo 'DÃ©ploiement sur Kubernetes (Minikube)...'
                script {
                    sh '''
                        # CrÃ©er le namespace
                        kubectl create namespace ${K8S_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
                        
                        # CrÃ©er les ConfigMaps
                        kubectl delete configmap backend-config -n ${K8S_NAMESPACE} --ignore-not-found
                        kubectl create configmap backend-config \
                          --from-literal=MONGODB_URI=mongodb://smartphone-mongo:27017/samadb \
                          --from-literal=PORT=${BACKEND_PORT} \
                          --from-literal=NODE_ENV=production \
                          -n ${K8S_NAMESPACE}
                        
                        # CrÃ©er les secrets Docker pour DockerHub
                        kubectl delete secret dockerhub-secret -n ${K8S_NAMESPACE} --ignore-not-found
                        kubectl create secret docker-registry dockerhub-secret \
                          --docker-server=docker.io \
                          --docker-username=${DOCKERHUB_USERNAME} \
                          --docker-password=${DOCKERHUB_CREDENTIALS_PSW} \
                          --docker-email=your-email@example.com \
                          -n ${K8S_NAMESPACE}
                        
                        # Appliquer les manifests Kubernetes
                        kubectl apply -f k8s/namespace.yaml
                        kubectl apply -f k8s/mongodb-pvc.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/mongodb-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/backend-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/backend-service.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/frontend-deployment.yaml -n ${K8S_NAMESPACE}
                        kubectl apply -f k8s/frontend-service.yaml -n ${K8S_NAMESPACE}
                        
                        echo "Attente du dÃ©ploiement des pods..."
                        kubectl wait --for=condition=available --timeout=300s deployment/smartphone-backend -n ${K8S_NAMESPACE} || true
                        kubectl wait --for=condition=available --timeout=300s deployment/smartphone-frontend -n ${K8S_NAMESPACE} || true
                    '''
                }
            }
        }
        
        stage('ğŸ’š Health Checks') {
            steps {
                echo 'VÃ©rification de santÃ© des services Kubernetes...'
                script {
                    sh '''
                        echo "Ã‰tat des pods..."
                        kubectl get pods -n ${K8S_NAMESPACE}
                        
                        echo "Ã‰tat des services..."
                        kubectl get svc -n ${K8S_NAMESPACE}
                        
                        echo "Attente que MongoDB soit prÃªt..."
                        kubectl wait --for=condition=ready pod -l app=smartphone-mongo -n ${K8S_NAMESPACE} --timeout=300s || true
                        sleep 10
                        
                        echo "Attente que le backend soit prÃªt..."
                        kubectl wait --for=condition=ready pod -l app=smartphone-backend -n ${K8S_NAMESPACE} --timeout=300s || true
                        sleep 10
                        
                        # Port forwarding et test
                        kubectl port-forward -n ${K8S_NAMESPACE} svc/smartphone-backend 5000:5000 &
                        PF_PID=$!
                        sleep 5
                        
                        retry_count=0
                        until curl -f http://localhost:5000/api/health || [ $retry_count -ge 5 ]; do
                            echo "Tentative de connexion au backend... ($retry_count/5)"
                            sleep 5
                            retry_count=$((retry_count + 1))
                        done
                        
                        kill $PF_PID 2>/dev/null || true
                        echo "âœ… Backend est opÃ©rationnel"
                    '''
                }
            }
        }
        
        stage('ğŸ“Š Display Deployment Info') {
            steps {
                script {
                    sh '''
                        echo "
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI ! ğŸ‰                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“± Application Smartphone Management                      â•‘
â•‘                                                            â•‘
â•‘  Namespace: ${K8S_NAMESPACE}                               â•‘
â•‘  Context: ${K8S_CONTEXT}                                   â•‘
â•‘                                                            â•‘
â•‘  Pour accÃ©der Ã  l'application :                           â•‘
â•‘  1. Backend :                                              â•‘
â•‘     kubectl port-forward -n ${K8S_NAMESPACE} svc/smartphone-backend 5000:5000
â•‘  2. Frontend :                                             â•‘
â•‘     kubectl port-forward -n ${K8S_NAMESPACE} svc/smartphone-frontend 80:80
â•‘                                                            â•‘
â•‘  Puis :                                                    â•‘
â•‘  - Frontend:  http://localhost                            â•‘
â•‘  - Backend:   http://localhost:5000                       â•‘
â•‘  - Health:    http://localhost:5000/api/health            â•‘
â•‘                                                            â•‘
â•‘  ğŸ³ DockerHub: ${DOCKERHUB_USERNAME}                       â•‘
â•‘  ğŸ·ï¸  Build:     #${BUILD_NUMBER}                           â•‘
â•‘                                                            â•‘
â•‘  Images :                                                  â•‘
â•‘  - ${BACKEND_IMAGE}:${IMAGE_TAG}                          â•‘
â•‘  - ${FRONTEND_IMAGE}:${IMAGE_TAG}                         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        "
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'Nettoyage...'
            sh '''
                docker image prune -f || true
            '''
        }
        
        success {
            echo 'âœ… Pipeline exÃ©cutÃ© avec succÃ¨s !'
        }
        
        failure {
            echo 'âŒ Le pipeline a Ã©chouÃ© !'
            sh '''
                echo "Ã‰tat du namespace:"
                kubectl describe namespace ${K8S_NAMESPACE} || true
                echo "Ã‰tat des pods:"
                kubectl get pods -n ${K8S_NAMESPACE} || true
                echo "Logs des pods:"
                kubectl logs -n ${K8S_NAMESPACE} -l app=smartphone-backend || true
            '''
        }
    }
}